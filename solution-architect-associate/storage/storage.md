# ストレージ

---
## EBS
### ボリュームタイプ
* SSDはIOPS、HDDはMB/sを性能指標としている
* IO負荷を無視すれば、HDDの方がコスト最適とスループットの両方を保持できる

|  | タイプ | ユースケース | サイズ |
| --- | --- | --- | --- |
| SSD | 汎用SSD（gp2） | EC2のブートボリューム、アプリケーション | 1GB~16TB |
| | プロビジョンドIOPS SSD（io1） | I/O性能が必要なDB・アプリ | 4GB~16TB |
| HDD | スループット最適化HDD（st1） | ビックデータ分析、DWH、ログ分析 | 500GB~16TB |
| | コールドHDD（sc1） | アクセス頻度が低いデータアーカイブ | 1GB~1TB |

---
## S3/Glacier
### ストレージクラス

### 耐久性と整合性
* 耐久性
  - 複数のAZ・AZ内の複数の物理ストレージに複製されることで、高い耐久性を維持
* 整合性
  - **結果整合性の方式を採用**
  - データの保存後、複製が完全に終わるまでの間にデータを参照すると、
    参照先によっては保存前の状態が取得されることに注意

### ライフサイクル管理
* 移行アクション
  - データの利用頻度に応じてストレージクラスを変更するアクション
* 有効期限アクション
  - 指定された期限を超えたオブジェクトを削除するアクション
* ユースケース
  - 一定期間でアーカイブ： S3(Standard) => Glacier
  - 一定期間で安価な場所： S3(Standard) => S3(Standard-IA)
  - 一定期間で削除： S3(Standard) => 削除

### バージョン管理

### アクセス制御

### 署名付きURL
* アクセスを許可するオブジェクトに対して、期限を設定してURLを発行する機能
* バケットやオブジェクトのアクセス制御を変更することなく、一時的にアクセスを許可したい場合に有効
* 署名付きURLを知っていれば誰でもアクセスできる点に注意

> 詳細は https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/PresignedUrlUploadObject.html

### Webサイトホスティング
* 低コストでサーバーレスなウェブサイトのホスティング可能
* Route 53による独自ドメインの設定が可能
* 単独ではSSLを利用できないが、CloudFrontと連携させることでHTTPSの利用も可能

---
## EFS
* EC2・Lambdaなど複数のクライアントから同時アクセスが可能なファイルストレージサービス
* クライアントからのEFSへの接続は、一般的なNFS（NFSv4プロトコル。POSIX準拠）をサポートしているため、NFSクライアントさえあれば特別なツールやライブラリは不要
* EFSのマウント先としてAWSおよびオンプレのリソースで使用可能
  + https://docs.aws.amazon.com/ja_jp/efs/latest/ug/how-it-works.html
* WindowsベースのクライアントではeFSは使用できない。
  ただし、代替サービスとしてAmazon FSx for Windows File Serverが利用できる（FSxはNTFSファイルシステム）

## FSx

## Storage Gateway
出展： https://aws.amazon.com/jp/storagegateway/
![](https://d1.awsstatic.com/pdp-how-it-works-assets/product-page-diagram_AWS-Storage-Gateway_HIW@2x.6df96d96cdbaa61ed3ce935262431aabcfb9e52d.png)

* オンプレミスにあるデータをクラウドへ連携するための受け口を提供するサービス
* データの保存先は、S3やS3 Glacierといった耐久性が高く低コストなストレージを利用
* キャッシュストレージとしてはEBSを利用
* オンプレミス・AWSのどちら側にも配置が可能
  + オンプレミス向けにはVMwareやHyper-Vで利用できるイメージを提供。
    これらのハイパーバイザー環境があればかんたんに導入可能
  + AWS向けにはEC2インスタンスのStorage Gateway様AMIを用意

### ゲートウェイタイプ
ファイルゲートウェイ・ボリュームゲートウェイ・テープゲートウェイが用意されている
* ファイルゲートウェイ・キャッシュ型ボリュームゲートウェイは、参照度の高いデータは「ファイルキャッシュ」として、オンプレのキャッシュボリュームに配置する
* 一方、保管型ボリュームゲートウェイは、プライマリのデータの保存場所はオンプレ側であり、S3はスナップショットの置き場所と、S3の意味合いが異なる

| タイプ | | 配置先 | S3での保存単位 | S3への保存タイミング | プライマリデータの保存場所 | ファイルキャッシュ | クライアントIF | S3 APIからのアクセス |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ファイル | | オンプレ,EC2 | ファイル | 非同期ほぼリアルタイム | S3 | あり（一部） | NFSv3,v4.1 | 可 |
| ボリューム | キャッシュ型 | オンプレ,EC2 | ボリューム | 非同期スナップショット | S3 | あり（一部） | iSCSI | 不可 |
| | 保管型 | オンプレ | ボリューム | 非同期スナップショット | ローカルディスク | あり（全部） | iSCSI | 不可 |
| テープ | | オンプレ,EC2 | 仮想テープ | 非同期バックアップ | ローカルディスク | なし | iSCSI | 不可 |

> iSCSIインターフェースはEBS,S3,Glacierには存在しない。
> よって、iSCSIインターフェースを利用したい場合は自動的にStorage Gatewayが必要となる

