# ストレージ

| ストレージ | サービス | 特徴 |
| --- | --- | --- |
| ブロックストレージ | EBS、インスタンスストア | EC2にアタッチして活用するストレージサービス。ブロック形式でデータを保存。高速・広帯域幅 | 
| オブジェクトストレージ | S3、Glacier | 安価で高い耐久性を持つストレージサービス。オブジェクト形式でデータを保存（ファイルシステムは存在しない） |
| ファイルストレージ | EFS | 複数のEC2から同時にアタッチ可能な共有ストレージサービス。保存形式はファイル形式 |

---
## EBS
### ボリュームタイプ
* SSDはIOPS、HDDはMB/sを性能指標としている
* IO負荷を無視すれば、HDDの方がコスト最適とスループットの両方を保持できる

|  | タイプ | ユースケース | サイズ |
| --- | --- | --- | --- |
| SSD | 汎用SSD（gp2） | EC2のブートボリューム、アプリケーション | 1GB~16TB |
| | プロビジョンドIOPS SSD（io1） | I/O性能が必要なDB・アプリ | 4GB~16TB |
| HDD | スループット最適化HDD（st1） | ビックデータ分析、DWH、ログ分析 | 500GB~16TB |
| | コールドHDD（sc1） | アクセス頻度が低いデータアーカイブ | 1GB~1TB |

> * I/0負荷が集中するトランザクションワークロードの場合は、基本的にはSSDを選択。稼働するプロセスが少ない一方で大規模なビッグデーし処理が必要な場合はスループット最適化HDDを選択
> * また、基本的にコスト最適を問われたらHDD、コスト効率を問われたらSSDとなることが多そう
> * また、EBSボリュームに対して暗号化設定を行うと、データを暗号化できる

### EBSスナップショット
* EBSボリュームのある時点のバックアップ
* 最初は完全バックアップ、その後は増分バックアップを行う
* EBSスナップショットの実体はS3（よってリージョン単位）で保存される
* EBSスナップショットは非同期で作成するため、スナップショット作成中もバックアップ元のEBSボリュームは通常通り利用できる


### Data Lifecycle Manager (DLM)
* EBSのスナップショット作成や削除のスケジューリングを設定

---
## S3/Glacier
### ストレージクラス
S3のストレージクラス

| タイプ | 特徴 | 性能 |
| --- | --- | --- |
| Standard | | |
| Standard-IA[※2] | | |
| One Zone-IA | | |
| RRS[※3] | | |

* [※1] トリプルイレブン=99.999999999%
* [※2] Infrequency Access（低頻度アクセス）の略
* [※3] RRSの利用は現在は非推奨

Glacierのストレージクラス

| タイプ | 特徴 | 性能 |
| --- | --- | --- |
| Glacier Flexible Retrieval（通常のGlacier） | S3より低コスト。データ抽出（標準取り出し）に3〜5時間を要する。迅速取り出しなら1〜5分、ただし高コスト | 耐久性：トリプルイレブン、可用性：99.99% |
| Glacier Instant Retrieval | ミリ秒単位での取り出しが可能だが、Flexible Retrievalより高コスト（画像やニュースメディア向け）。取り出しアクセスが低頻度ならS3よりコストを削減可能 | 同上 |
| Glacier Deep Archive | 基本的なデータモデル・管理はGlacierと同じだが、データ取得はさらに遅くなる分コストは削減できる。標準取り出しで12時間以内・大量取り出しで48時間以内 | 同上 |

> Glacierの最低保持期間は90日のため、それより短い期間でオブジェクトを削除しても90日間分の費をを課金される。保持期間が短い場合はS3の方が低コストとなることがあるので注意

### 耐久性と整合性
* 耐久性
  - 複数のAZ・AZ内の複数の物理ストレージに複製されることで、高い耐久性を維持
* 整合性
  - **強い整合性モデル**をサポート
  - 2020/12のアップデートまでは結果整合性モデル
    + データの保存後、複製が完全に終わるまでの間にデータを参照すると、
      参照先によっては保存前の状態が取得されていた

### ライフサイクル管理
* 移行アクション
  - データの利用頻度に応じてストレージクラスを変更するアクション
* 有効期限アクション
  - 指定された期限を超えたオブジェクトを削除するアクション
* ユースケース
  - 一定期間でアーカイブ： S3(Standard) => Glacier
  - 一定期間で安価な場所： S3(Standard) => S3(Standard-IA)
  - 一定期間で削除： S3(Standard) => 削除

### バージョン管理
* 更新する度に個別のバージョンが振られる
* 削除したオブジェクトを復元することも可能
* バージョニングはデフォルトでは無効なので、利用する場合は有効にする必要がある

### アクセス制御
* S3 MFA Delete
  - S3バケットた対しMFA認証を有効化
  - ユーザー処理に対し毎回MFA認証を求められるため、操作ミスによる削除を防ぐことができる

### 署名付きURL
* アクセスを許可するオブジェクトに対して、期限を設定してURLを発行する機能
* バケットやオブジェクトのアクセス制御を変更することなく、一時的にアクセスを許可したい場合に有効
* 署名付きURLを知っていれば誰でもアクセスできる点に注意

> 詳細は https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/PresignedUrlUploadObject.html

### 静的Webサイトホスティング
* 低コストでサーバーレスなウェブサイトのホスティング可能
* Route 53による独自ドメインの設定が可能
* 単独ではSSLを利用できないが、CloudFrontと連携させることでHTTPSの利用も可能

ホスティングの手順
1. パブリックアクセスブロックの無効化
2. バケットポリシーでインターネットからのバケットの読み取り許可（`s3:GetObject`）を設定
3. index.htmlなどのHTMLドキュメントばバケット内に保存
4. 静的Webサイトホスティングを有効化し、index.htmlをデフォルトページに設定

### データ暗号化
* SSE = Server Side Encryption
* CSE = Client Side Encryption

| 方式 | 特徴 |
| --- | --- |
| SSE-S3 | S3の標準暗号化方式。AES-256を採用 |
| SSE-KMS | AWS KMSで設定したキーを利用して暗号化を実施。ユーザー側でKMSを使用してキーを作成・管理 |
| SSE-C | ユーザーが指定したキーにより暗号化を実施（C=Client）。ユーザー側でキーの要件に対し柔軟に対応できる |
| CSE | クライアント側でS3に送信する前にデータを暗号化 |

### S3 Transfer Acceleration
* クライアントとS3バケット間で長距離のファイル転送を高速・簡単・安全に行うことが可能になる機能
* 具体的には
  - クライアントはS3にアップロードを実行すると、地理的にいちばん近いエッジロケーションにアップロードされる
  - AWS側でエッジロケーションからS3バケットの実体へデータこ高速に転送される
* Transfer AccelerationのエッジロケーションはCloudFrontのエッジロケーションを利用している

### S3 Select
S3内で直接SQLクエリを実行し必要なオブジェクトのサブセットのみを取得できる

---
## EFS
* EC2・Lambdaなど複数のクライアントから同時アクセスが可能なファイルストレージサービス
* クライアントからのEFSへの接続は、一般的なNFS（NFSv4プロトコル。POSIX準拠）をサポートしているため、NFSクライアントさえあれば特別なツールやライブラリは不要
* EFSのマウント先としてAWSおよびオンプレのリソースで使用可能
  + https://docs.aws.amazon.com/ja_jp/efs/latest/ug/how-it-works.html
* WindowsベースのクライアントではeFSは使用できない。
  ただし、代替サービスとしてAmazon FSx for Windows File Serverが利用できる（FSxはNTFSファイルシステム）

## FSx (for Windows File Server)
https://aws.amazon.com/jp/fsx/windows/
![](https://d1.awsstatic.com/pdp-how-it-works-assets/Product-Page-Diagram_Managed-File-System-How-it-Works_Updated@2x.c0c4e846c0fca27e8f43bd1651883b21b4cc1eec.png)

* フルマネージド型のMicrosoft Windowsファイルシステム（NTFS）の共有ストレージを提供するサービス
* SMBプロトコルを使って最大数千台のコンピューティングインスタンスからアクセス可能なファイルシステムを提供
* Windows File Server以外に、NetApp ONTAP、OpenZFS、Lustre向けのサービスもある https://aws.amazon.com/jp/fsx/

## Storage Gateway
https://aws.amazon.com/jp/storagegateway/
![](https://d1.awsstatic.com/pdp-how-it-works-assets/product-page-diagram_AWS-Storage-Gateway_HIW@2x.6df96d96cdbaa61ed3ce935262431aabcfb9e52d.png)

* オンプレミスにあるデータをクラウドへ連携するための受け口を提供するサービス
* データの保存先は、S3やS3 Glacierといった耐久性が高く低コストなストレージを利用
* キャッシュストレージとしてはEBSを利用
* オンプレミス・AWSのどちら側にも配置が可能
  + オンプレミス向けにはVMwareやHyper-Vで利用できるイメージを提供。
    これらのハイパーバイザー環境があればかんたんに導入可能
  + AWS向けにはEC2インスタンスのStorage Gateway様AMIを用意

### ゲートウェイタイプ
ファイルゲートウェイ・ボリュームゲートウェイ・テープゲートウェイが用意されている
* ファイルゲートウェイ・キャッシュ型ボリュームゲートウェイは、参照度の高いデータは「ファイルキャッシュ」として、オンプレのキャッシュボリュームに配置する
* 一方、保管型ボリュームゲートウェイは、プライマリのデータの保存場所はオンプレ側であり、S3はスナップショットの置き場所と、S3の意味合いが異なる

| タイプ | | 配置先 | S3での保存単位 | S3への保存タイミング | プライマリデータの保存場所 | ファイルキャッシュ | クライアントIF | S3 APIからのアクセス |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ファイル | | オンプレ,EC2 | ファイル | 非同期ほぼリアルタイム | S3 | あり（一部） | NFSv3,v4.1 | 可 |
| ボリューム | キャッシュ型 | オンプレ,EC2 | ボリューム | 非同期スナップショット | S3 | あり（一部） | iSCSI | 不可 |
| | 保管型 | オンプレ | ボリューム | 非同期スナップショット | ローカルディスク | あり（全部） | iSCSI | 不可 |
| テープ | | オンプレ,EC2 | 仮想テープ | 非同期バックアップ | ローカルディスク | なし | iSCSI | 不可 |

> iSCSIインターフェースはEBS,S3,Glacierには存在しない。
> よって、iSCSIインターフェースを利用したい場合は自動的にStorage Gatewayが必要となる

