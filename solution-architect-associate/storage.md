# ストレージ
AWSは3つの形式のストレージサービスを提供。

| ストレージ | サービス | 特徴 |
| --- | --- | --- |
| ブロックストレージ | EBS、インスタンスストア | EC2にアタッチして活用するストレージサービス。ブロック形式でデータを保存。高速・広帯域幅 | 
| オブジェクトストレージ | S3、Glacier | 安価で高い耐久性を持つストレージサービス。オブジェクト形式でデータを保存（ファイルシステムは存在しない） |
| ファイルストレージ | EFS | 複数のEC2から同時にアタッチ可能な共有ストレージサービス。保存形式はファイル形式 |

---
## EBS
EC2にアタッチされるブロックレベルのストレージサービス

### EBSの特徴
* OS、アプリケーション、その他汎用データの置き場所として活用
* 99.999%の可用性、サイズは1GB~16TB。サイズ・利用期間で課金
* ボリュームデータはデフォルトでAZ内で複数のHWでレプリケートされており、**冗長化は不要**
* セキュリティグループの対象外。全ポートを閉じてもEBSは利用可能
* EBSの付け替えは同じAZ内のインスタンスなら可能
* クロスゾーン不可（他のAZのインスタンスからはアタッチできない）
* EBSボリュームに対して暗号化設定を行うと、データを暗号化できる
* EBSマルチアタッチ
  * 1つのEBSを複数のインスタンスで共有することは基本的にはできないが、
    **プロビジョンドIOPSのみ共有が可能となった**
  * https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ebs-volumes-multi.html

### ボリュームタイプ
* SSDはIOPS、HDDはMB/sを性能指標としている
* IO負荷を無視すれば、HDDの方がコスト最適とスループットの両方を保持できる

|  | タイプ | ユースケース | 最大スループット | サイズ |
| --- | --- | --- | --- | --- |
| SSD | 汎用SSD（gp2） | EC2のブートボリューム、アプリケーション | 250MiB/sec | 1GB~16TB |
| | プロビジョンドIOPS SSD（io2） | I/O性能が必要なDB・アプリ | 1,000MiB/sec | 4GB~16TB |
| | プロビジョンドIOPS SSD（io2 Block Express） | I/O性能を備えつつ、高いスループットを実現 | 4,000MiB/sec | |
| HDD | スループット最適化HDD（st1） | ビックデータ分析、DWH、ログ分析 | 1,000MiB/sec | 500GB~16TB |
| | コールドHDD（sc1） | アクセス頻度が低いデータアーカイブ | | 1GB~1TB |

> * I/0負荷が集中するトランザクションワークロードの場合は、基本的にはSSDを選択。稼働するプロセスが少ない一方で大規模データ処理が必要な場合はスループット最適化HDDを選択
> * また、基本的にコスト最適を問われたらHDD、コスト効率を問われたらSSDとなることが多そう

### EBSスナップショット
* EBSボリュームのある時点のバックアップ
* 最初は完全バックアップ、その後は増分バックアップを行う
* スナップショットからEBSを復元する際は、他のAZも選択可能
* EBSスナップショットの実体はS3（よってリージョン単位）で保存される
* EBSスナップショットは非同期で作成するため、スナップショット作成中もバックアップ元のEBSボリュームは通常通り利用できる

### Data Lifecycle Manager (DLM)
* EBSのスナップショット作成や削除のスケジューリングを設定

### IOPS
* IOPSとは
  - 1秒あたりの入出力操作（I/O）数を表す測定単位
  - リクエストされたボリュームサイズに対するプロビジョンドIOPSの最大比率(GiB単位)は、io1ボリュームで `50:1`、io2ボリュームで `500:1`
  - io1（プロビジョンドIOPS）を例に取ると、
    + 100GiB なら 5000IOPS
    + 10GiB なら 500IOPS
  - つまり、IOPSを上げようと思うと、ブロックサイズを上げる都合上、
    ストレージの容量も上げないといけない
    + 例えば、3200IOPSなら、3200/50 = 64GiB が、最低ストレージ容量
* スループットとは
  - 1秒あたりの最大データ転送量の測定単位
  - 単位はGbps、Mbpsなど
* IOPSとスループット
  - サイズが4KB以下のファイルを大きく書き込むような場合は、IOPSを
  - １度の書き込みが数GBのような単位なら、スループットを
  - 重視した方がパフォーマンスは上がりやすい

### RAID構成
パフォーマンス向上と冗長性を高める目的で、EBSでは主にRAID0、RAID1の構成が実施される。

| 構成 | 特徴 |
| --- | --- |
| RAID 0（ストライピング） | パフォーマンスの向上が目的。複数のディスクを1台のディスクのように扱い、読み書きを高速化する構成<br>https://dev.classmethod.jp/articles/amazon-ebs-raid0/ |
| RAID 1（ミラーリング） | ボリュームの冗長性を高めるのが目的。2つのボリュームを同時にミラーリング |

### マルチアタッチ


---
## S3
### ストレージクラス

| タイプ | 特徴 | 性能 | 追加料金 |
| --- | --- | --- | --- |
| Standard | 頻繁に利用するデータを大量に保存するのに適している | 耐久性：イレブンナイン<br>可用性99.99% | なし |
| Standard-IA[※2] | 低頻度でアクセスするデータ用のストレージ。One Zone-IAより重要なマスタデータ向け。データ取得は速い。Starndardより安価でOne Zone-IAより高価 | 耐久性：イレブンナイン<br>可用性：99.9% | 最低利用料金：30日<br>データ取得料金：GBあたりの料金 |
| One Zone-IA | 低頻度アクセス用ストレージ。マルチAZではないため可用性が低く重要でないデータ向け。Standard-IAより安い | 耐久性：イレブンナイン<br>可用性：99.5% | 同上 |
| S# Intelligent Tiering | 高頻度（Starndard）/低頻度（Starndard-IA）で2つのアクセス階層を利用し、アクセス頻度に応じて自動的に移動。アクセスパターンがわからない時に最適 | 耐久性：イレブンナイン<br>可用性：99.9% | 最低利用料金：30日<br>データ取得料金：なし

> RRSの利用は現在は非推奨

* [※1] トリプルイレブン=99.999999999%
* [※2] Infrequency Access（低頻度アクセス）の略

### 耐久性と整合性
* 耐久性
  - 複数のAZ・AZ内の複数の物理ストレージに複製されることで、高い耐久性を維持
* 整合性
  - **強い整合性モデル**をサポート
  - 2020/12のアップデートまでは結果整合性モデル
    + データの保存後、複製が完全に終わるまでの間にデータを参照すると、
      参照先によっては保存前の状態が取得されていた

### バージョン管理
* 更新する度に個別のバージョンが振られる
* 削除したオブジェクトを復元することも可能
* バージョニングはデフォルトでは無効なので、利用する場合は有効にする必要がある

> オブジェクトのバージョン管理をする場合は、長期に渡りバージョンを残すと
> 大量のバージョンが残りパフォーマンスが低下するため、
> ライフサイクルと組み合わせて運用する必要がある

### アクセス管理

| 管理方式 | 特徴 |
| --- | --- |
| IAMユーザーポリシー | IAMユーザーに対してAWSリソースとしてのS3へのアクセス権限を設定 |
| バケットポリシー | 1つのバケットに対して1つのJSONファイルでアクセス権を設定。外部ユーザーやアプリケーションに対する設定も可能 |
| ACL | バケット/オブジェクト単位でのアクセス権限をXMLファイルで設定。**オブジェクトに個別に設定可能** |
| S3アクセスポイント | バケットのアクセス権をJSONファイルで設定。1つのバケットに対して複数設定可能。外部ユーザーやアプリケーションに対する設定も可能 |

#### S3アクセスポイント
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2019/12/d6fe730a319ece255d3425e9649d296e-320x206.png)
https://dev.classmethod.jp/articles/explain-the-good-point-of-s3-access-points/

* S3の共有データセットへの大規模なデータアクセスの管理を簡素化する機能
* アクセスポイントとは、具体的には、バケットにアタッチされた名前付きのネットワークエンドポイント
* 各アクセスポイントは、もととなるバケットにアタッチされたバケットポリシーと
  連動して機能する、カスタマイズされたアクセスポリシーを適用してアクセスの制御が可能

#### ブロックパブリックアクセス
* インターネットからのアクセスをブロックする機能
* 初期設定では有効化されている（ブロックがオンになっている）

#### 署名付きURL
* アクセスを許可するオブジェクトに対して、期限を設定してURLを発行する機能
* バケットやオブジェクトのアクセス制御を変更することなく、一時的にアクセスを許可したい場合に有効
* **そのURLを知っていれば誰でもアクセスできる点に注意**

> 詳細は https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/PresignedUrlUploadObject.html

### S3のデータ保護
#### 通信暗号化
* HTTPエンドポイント：非暗号化。デフォルトでは非推奨
* HTTPSエンドポイント：通信経路でSSL/TLS通信が自動適用。ユーザー側で証明書の設定の必要なし

#### データ暗号化
* SSE = Server Side Encryption
* CSE = Client Side Encryption

| 方式 | 特徴 |
| --- | --- |
| SSE-S3 | S3の標準暗号化方式。**AES-256を採用** |
| SSE-KMS | AWS KMSで設定したキーを利用して暗号化を実施。ユーザー側でKMSを使用してキーを作成・管理 |
| SSE-C | ユーザーが指定したキーにより暗号化を実施（C=Client）。ユーザー側でキーの要件に対し柔軟に対応できる |
| CSE | クライアント側でS3に送信する前にデータを暗号化 |

#### S3 MFA Delete
* S3バケットに対しMFA認証を有効化
* ユーザー処理に対し毎回MFA認証を求められるため、操作ミスによる削除を防ぐことができる

### S3イベント
S3オブジェクト操作と連動したシステム連携処理を実現

* SNS
  * S3をトリガーとしてSNSトピックを発行。メールなどを通知できる
* SQS
  * S3をトリガーとしてキューに配信
* Lambda
  * S3をトリガーとしてLambda関数を実行できる

### S3のパフォーマンス
#### S3 Transfer Acceleration
* クライアントとS3バケット間で長距離のファイル転送を高速・簡単・安全に行うことが可能になる機能
* 具体的には
  - クライアントはS3にアップロードを実行すると、地理的にいちばん近いエッジロケーションにアップロードされる
  - AWS側でエッジロケーションからS3バケットの実体へデータこ高速に転送される
* Transfer AccelerationのエッジロケーションはCloudFrontのエッジロケーションを利用している

### 静的Webサイトホスティング
* 低コストでサーバーレスなウェブサイトのホスティング可能
* Route 53による独自ドメインの設定が可能
* 単独ではSSLを利用できないが、CloudFrontと連携させることでHTTPSの利用も可能

ホスティングの手順
1. パブリックアクセスブロックの無効化
2. バケットポリシーでインターネットからのバケットの読み取り許可（`s3:GetObject`）を設定
3. index.htmlなどのHTMLドキュメントばバケット内に保存
4. 静的Webサイトホスティングを有効化し、index.htmlをデフォルトページに設定

エンドポイントのURLは以下の2つの形式が利用可能
* `http://{bucket-name}.s3-website-{region}.amazonaws.com`
* `http://{bucket-name}.s3-website.{region}.amazonaws.com`

#### Route53によるドメイン設定
* トラフィック先としてS3 Webサイトエンドポイントへのエイリアス（リージョン)を選択
* レコードタイプとしてエイリアスレコードのAレコード（IPv4）を設定
* バケット名とドメイン名またはサブドメイン名を同じにする必要がある

#### CORS（クロスオリジンリソースシェアリング）
* https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/cors.html
* ドメインが設定されているS3バケットを他の複数のドメインに共有できる

> CORSとは
> * 特定のドメインにロードされたクライアントウェブアプリケーション
>  （要はブラウザ）が異なるドメイン内のリソースを取得する
>  （クロスオリジンリクエストを可能にする）仕組み
> * CORS対応は、データが呼ばれる側でCORSルールを設定する

### ライフサイクル管理
* 移行アクション
  - データの利用頻度に応じてストレージクラスを変更するアクション
* 有効期限アクション
  - 指定された期限を超えたオブジェクトを削除するアクション
* ユースケース
  - 一定期間でアーカイブ： S3(Standard) => Glacier
  - 一定期間で安価な場所： S3(Standard) => S3(Standard-IA)
  - 一定期間で削除： S3(Standard) => 削除

### レプリケーション
* 同一リージョンレプリケーション（SSR）
  * 同一リージョンの別のバケットに同じデータを保存
* 別リージョンのレプリケーション（CRR）
  * 災害対応
  * リージョン別のアクセスの低レイテンシー化

#### クロスリージョンレプリケーション
S3のオブジェクトを別リージョンにレプリケーションする機能。
レプリケーションなので完全同期となる。

* クロスリージョンレプリケーションの実行方法
  1. レプリケート元のバケットの所有者は自分のアカウントに対しての送信元/先のリージョンを有効に
  2. レプリケート元/先でバージョニングを有効に
  3. レプリケート元バケットのオブジェクトをレプリケート先のバケットにレプリケートするアクセス許可を設定
  4. レプリケート元のバケット所有者がそのバケット内のオブジェクトを所有していない場合、オブジェクト所有者はACLによりバケット所有者への読み出し権限（READ,READ_ACP）を付与
  5. レプリケート元のバケットでオブジェクトロックが有効になっている場合、レプリケート先でもオブジェクトロックを有効にする

### S3の利用状況分析

| 分析機能 | 特徴 |
| --- | --- |
| S3サーバアクセスログ | バケットに対するリクエストの詳細をロギング |
| S3 Access Analyzer | S3バケットに対して任意のユーザーや任意のAWSアカウント（組織外含む）にアクセス許可が適切になされているかを評価・警告する |
| S3ストレージクラス分析 | データのアクセス頻度を分析。Standard->IAへの移行判断。ライフサイクルポリシーの設定 |
| S3 Storage Lens | データの使用状況とアクテビティのメトリクス集計・分析 |

### S3データの解析
#### S3 Select
* S3内で直接SQLクエリを実行し必要なオブジェクトのサブセットのみを取得できる
* Gzip圧縮データやCSV,JSONに対して実行可能

## Glacier
### ストレージクラス

| タイプ | 特徴 | 性能 |
| --- | --- | --- |
| Glacier Flexible Retrieval（通常のGlacier） | S3より低コスト。データ抽出（標準取り出し）に3〜5時間を要する。迅速取り出しなら1〜5分、ただし高コスト | 耐久性：トリプルイレブン<br>可用性：99.99% |
| Glacier Instant Retrieval | ミリ秒単位での取り出しが可能だが、Flexible Retrievalより高コスト（画像やニュースメディア向け）。取り出しアクセスが低頻度ならS3よりコストを削減可能 | 同上 |
| Glacier Deep Archive | 基本的なデータモデル・管理はGlacierと同じだが、データ取得はさらに遅くなる分コストは削減できる。<br>標準取り出しで12時間以内・大量取り出しで48時間以内 | 同上 |

> Glacierの最低保持期間は90日のため、それより短い期間でオブジェクトを削除しても90日間分の費をを課金される。保持期間が短い場合はS3の方が低コストとなることがあるので注意

### Glacierボールトロック（Valut Lock）
* Glacierのアーカイブ（S3でいうオブジェクトに相当するモデル）に対し、Vault Lockポリシーを適用すると、アーカイブにロックがかかり、登録から1年間はアーカイブの削除ができなくなる
* このような強力な制約をかけることで、コンプライアンス管理を強化する

---
## EFS
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/551f33494bf9c1c2185e8d3cfed2eb03-768x649.png)

* EC2・Lambdaなど複数のクライアントから同時アクセスが可能なファイルストレージサービス
* クライアントからのEFSへの接続は、一般的なNFS（NFSv4プロトコル。POSIX準拠）をサポートしているため、NFSクライアントさえあれば特別なツールやライブラリは不要
* EFSのマウント先としてAWSおよびオンプレのリソースで使用可能
  + https://docs.aws.amazon.com/ja_jp/efs/latest/ug/how-it-works.html
  + マウント先は**マウントターゲット**というENIで定義
* **WindowsベースのクライアントではEFSは使用できない**。
  ただし、代替サービスとしてAmazon FSx for Windows File Serverが利用できる（FSxはNTFSファイルシステム）

### ライフサイクル
* 標準ストレージクラスと低頻度アクセス（IA）ストレージクラスがある
* EFSライフサイクルを有効にすると、選択したライフサイクルポリシーに従って
  アクセスがしないファイルは自動的かつ透過的にEFS IAに移される

### パフォーマンスモード
* 汎用モード
  + 一般的な用途を想定したモード
  + レイテンシーが最も低い
  + 1秒当たりのファイルシステム操作を7000に制限
* 最大I/Oモード
  + 何十〜何千というクライアントからの同時アクセスが必要な大規模構築で利用
  + 合計スループットを優先してスケール
  + レイテンシーは多少長くなる

### スループットモード
* バーストスループット
  + 性能を一時的に向上させることが可能
  + 容量に応じてクレジットの蓄積量とスループット性能が向上
* プロビジョンドスループット
  + 一貫したスループットを事前に設定する方式
  + バーストモードよりも高い性能するー


---
## FSx (for Windows File Server)
https://aws.amazon.com/jp/fsx/windows/
![](https://d1.awsstatic.com/pdp-how-it-works-assets/Product-Page-Diagram_Managed-File-System-How-it-Works_Updated@2x.c0c4e846c0fca27e8f43bd1651883b21b4cc1eec.png)

* フルマネージド型のMicrosoft Windowsファイルシステム（NTFS）の共有ストレージを提供するサービス
* SMBプロトコルを使って最大数千台のコンピューティングインスタンスからアクセス可能なファイルシステムを提供
* Windowsのネイティブファイルシステムと同じく、
  Access Control Lists（ACLs）、シャドウコピー、ユーザークォータなどの機能をサポートしている
* Windows File Server以外に、NetApp ONTAP、OpenZFS、Lustre向けのサービスもある https://aws.amazon.com/jp/fsx/

---
## Storage Gateway
https://aws.amazon.com/jp/storagegateway/
![](https://d1.awsstatic.com/pdp-how-it-works-assets/product-page-diagram_AWS-Storage-Gateway_HIW@2x.6df96d96cdbaa61ed3ce935262431aabcfb9e52d.png)

* オンプレミスにあるデータをクラウドへ連携するための受け口を提供するサービス
* データの保存先は、S3やS3 Glacierといった耐久性が高く低コストなストレージを利用
* キャッシュストレージとしてはEBSを利用
* オンプレミス・AWSのどちら側にも配置が可能
  + オンプレミス向けにはVMwareやHyper-Vで利用できるイメージを提供。
    これらのハイパーバイザー環境があればかんたんに導入可能
  + AWS向けにはEC2インスタンスのStorage Gateway様AMIを用意

### ゲートウェイタイプ
ファイルゲートウェイ・ボリュームゲートウェイ・テープゲートウェイが用意されている
* ファイルゲートウェイ・キャッシュ型ボリュームゲートウェイは、参照度の高いデータは「ファイルキャッシュ」として、オンプレのキャッシュボリュームに配置する
* 一方、保管型ボリュームゲートウェイは、プライマリのデータの保存場所はオンプレ側であり、S3はスナップショットの置き場所と、S3の意味合いが異なる

| タイプ | | 配置先 | S3での保存単位 | S3への保存タイミング | プライマリデータの保存場所 | ファイルキャッシュ | クライアントIF | S3 APIからのアクセス |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| ファイル | | オンプレ,EC2 | ファイル | 非同期ほぼリアルタイム | S3 | あり（一部） | NFSv3,v4.1 | 可 |
| ボリューム | キャッシュ型 | オンプレ,EC2 | ボリューム | 非同期スナップショット | S3 | あり（一部） | iSCSI | 不可 |
| | 保管型 | オンプレ | ボリューム | 非同期スナップショット | ローカルディスク | あり（全部） | iSCSI | 不可 |
| テープ | | オンプレ,EC2 | 仮想テープ | 非同期バックアップ | ローカルディスク | なし | iSCSI | 不可 |

> iSCSIインターフェースはEBS,S3,Glacierには存在しない。
> よって、iSCSIインターフェースを利用したい場合は自動的にStorage Gatewayが必要となる

## DataSync
![](https://d1.awsstatic.com/aws-datasync/case.53c1297e16befdbb5fde775c586d47f5770221bb.png)

* オンプレミスストレージとEFS、FSxなどのファイルシステム間でデータを迅速かつ
  かんたんに移動する際に利用するマネージド型のデータ転送サービス