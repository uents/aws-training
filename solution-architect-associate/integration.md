# インテグレーション

## SNS（Simple Notification Service）
フルマネージド型のpub/subメッセージングサービス。
他のサービスとの非同期通信を可能にする。

* AWS上でイベント通知やメッセージング処理/プッシュ通知をするユースケースで利用
* メッセージに永続性はない（配信された終了）
* コンポーネント間のメッセージ通知やアラート通知に利用
* アラーム設定からSMS,Eメール通知が可能。（一方、SESはSMSには対応していないので注意）
* デフォルトではメッセージの通信順序に保証はない
  + FIFOトピックにより順序保証が可能に
* メッセージサイズは最大256KB
* フィルタリング機能
  + SNS側で送信先を特定して、配信処理を限定するような用途で利用

### 連携可能なサービス

| サービス | pub/sub | 内容 |
| --- | --- | --- |
| CloudWatch | pub側 | Billing Alertの通知 |
| S3 | pub側 | ファイルがアップロードされた時の通知 |
| Elastic Transcoder | pub側 | 動画変換完了/失敗の通知 |
| SES | pub側 | Bounce/Compliantの通知<br>https://qiita.com/syouta/items/100cfa835c51c3ca7328  |
| モバイルプッシュ | pub側 | Apple Push Notification Service (APNs) のようなスマートフォン側のプッシュ通知サービスを介してモバイルデバイスにプッシュ通知<br>https://nopipi.hatenablog.com/entry/2019/02/17/024158 |
| SQS | sub側 | SNS通知よりキューを配信して、後続の処理を実行<br>https://dev.classmethod.jp/articles/cross-account-sns-sqs-integration/ |
| Lambda | sub側 | SNSをトリガーとして処理を起動 |

### アクセス管理
* IAMポリシー
  + 一般的なIAMポリシーによるSNSリソースへのアクセス許可を設定
* SNSポリシー
  + 他のアカウントとSNSを共有する許可を設定
  + 他のサービスがSNSにメッセージを送信することの許可を設定

## SQS（Simple Queue Service）
フルマネージド型のメッセージキュイーングサービス。producer/consumerモデル。

* **キューによってシステム処理の分散並列処理が可能**
  - https://aws.amazon.com/jp/blogs/developer/using-python-and-amazon-sqs-fifo-queues-to-preserve-message-sequencing/
  - キューの後続にLambdaやEC2 Auto Scalingグループを配置することで可能に
* キューに対して優先度を設定することが可能
* 受信側はポーリング通信で受信する（consumerが自分のタイミングで取りに行く）
* メッセージに永続性がある（consumerがメッセージを削除しなければ滞留する）
* 処理できるメッセージ数は**無制限**。メッセージサイズは最大256KB
* キューのメッセージの保持期間はデフォルトで**4日間**。最小60秒〜最大14日間まで設定叶

### キューの種類
* 標準キュー（Standardキュー） **[デフォルト設定]**
  - メッセージの**配信順序の保証なし**
  - 同一のメッセージが2回配信されることがある
  - TPS（1秒あたりのトランザクション数）の件数は無制限
* FIFOキュー
  - メッセージの配信順序が保証されている
  - 標準キューとは異なり、同一メッセージに2重取得はない
  - TPSの件数は300

### 可視性タイムアウト
* 他のコンシューマーが同じメッセージを再処理しないようにするには、可視性タイムアウトを設定する。（メッセージが受信された直後は、メッセージはキューに残ったまま）
* この可視性タイムアウトの有効期限（30秒〜12時間）内は、他のコンシューマーが同じメッセージを受信したり処理したりすることができない
* 有効期限をすぎると、別のインスタンスでキューからメッセージを取得できる

## SES
* Eメールの送受信機能を提供するサービス
* いわゆるMTAサービスのため、**CloudWatchアラームに対してフックするような用途ならSNSを利用する**

## MQ
Apache ActiveMQ向けのマネージド型メッセージブローカーサービス

## Step Functions
* ワークフローを制御するフルマネージドサービス
* Lambda関数や複数のAWSサービスをプロセスとして配置し、サーバレースのワークフロー作成・管理を実現
* Mapステートを使うことでタスクの分散処理も可能となる
* ワークフローの最大実行時間は1年
* ワークフローをマネジメントコンソールのGUIで変更できないSWF（Simple Workflow）というサービスもある
