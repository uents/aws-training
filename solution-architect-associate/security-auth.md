# セキュリティ
セキュリティの主要な柱
* データ保護
* 権限管理
* インフラ保護
* 検出制御

---
# データの保護
データの保護とは、基本的にはデータのトラフィック暗号化および保管データの暗号化を指す。

## KMS
S3や多くのデータベースサービスに統合されており、暗号化を容易に実施できる
* S3
  * サーバサイド暗号化/クライアントサイド暗号化を活用
* RDS
  * セキュリティグループによるトラフィックのアクセス制御
  * SSL/TLSによるアプリ-DB間の通信暗号化
  * 暗号化オプションにより保管データを暗号化

### KMSのモデル
* カスタマーキー（CMK）
  * AWS側の管理するマスターキー
  * 暗号化キーを管理する
* データキー（カスタマーデータキー、暗号化キー）
  * 実際のデータの暗号化に利用するキー
  * データキー自体はKMSで生成され、CMKで暗号化される
* エンベロープ暗号化
  * CMKで暗号化したデータキーを利用して、データを暗号化する方式
  * （CMKそのものは暗号化せずに運用）

### AWS Encryption SDK（AWS暗号化SDK）
* データの暗号化/複合化を誰でも行うことができるクライアント側の暗号化ライブラリ
* このライブラリを使用すると、開発中のアプリケーションに対して
  暗号化のベストプラクティスによる暗号化の仕組みを簡単に実装できる

## CloudHSM
* 専用ハードウェアモジュール（HSM）により暗号化キーを保護するサービス
* KMSの場合はAWSサービス（ある意味共有のサーバ）に対し、CloudHSMクラスタはユーザー専用であるため、VPC内にクラスタを作成する必要がある
* KMSよりより厳しい暗号化要件に対応することが可能

## AWS Certificate Manager（ACM）
* AWSが認証局となるSSL証明書を発行、または、外部プロバイダーから取得した証明書をインポートして管理するサービス
* AWSが認証局となるSSSL証明書は、マネコン内で発行・更新できるため（多少お高いらしいが）管理は楽
* CloudFrontで使用するSSL証明書マネージャでACMを直接利用できる
* ただし、**ACMが使用できないリージョンでは、IAMをSSL証明書マネージャーとして使用。**
  この場合は、外部プロバイダーからSSL証明書を取得する必要がある

---
# 権限管理
AWS責任共有モデルによる責務分担。ユーザー側の責任範囲は、
* 構築したアプリケーション
* アクセス権限（ユーザーアクセス、ロールベースのアクセス）
* ユーザーが利用するAWSサービス

具体的には、
* 構築したアプリケーションのセキュリティ対応
* OS/ミドルウェアの脆弱性対応
* IAMによるアカウント管理・パスワードルール
* セキュリティグループの設定等によるトラフィックの保護
* 通信トラフィックの暗号化・保有しているデータの暗号化

一方、ハードウェア、ネットワークインフラ、データセンターはAWS側の責任

## IAM（Identity and Access Management）
安全にAWS操作を実施するための認証・認可の仕組み
* AWSアカウント内のユーザーを作成
* AWSリソースへのアクセス権限を管理
* リソース間のアクセス権限を管理
* 一時的なアクセスを許可

### 主要な要素

| 要素 | 機能 |
| --- | --- |
| IAMポリシー | ユーザーなどへのアクセス権限を付与するためのJSON形式にドキュメント |
| IAMユーザー | AWSアカウント内に追加されるユーザー。AWS利用者はIAMユーザーという権限を付与されたエンティティとして設定される |
| IAMユーザーグループ | グループとしてまとめて権限を付与する仕組み。複数のIAMユーザーに対して設定される |
| IAMロール | AWSリソースに別のリソースに対するアクセス権限を付与する仕組み。別のAWSアカウントのIAMユーザーにアクセス権を移譲する際にも利用 |

| 要素 | 内容 |
| --- | --- |
| IAMリソース | IAMで保存・管理されるユーザー、グループ、ロール、ポリシー、およびIDプロパイダー |
| IAMアイデンティティ | ユーザー、グループ、およびロール |
| IAMエンティティ | ユーザーおよびロール |
| プリンシパル | アクションを実行する人、ルートユーザー、IAMユーザー、またはアプリケーション。フェデレーティッドユーザー（外部認証されたユーザー）と引き受けたロールも含まれる |

プリンシパルの指定パターン
* AWSアカウント単位で指定
  ``` json
  "Principal": { "AWS": "arn:aws:iam::123456789012:root" } 
  ```
  または
  ``` json
  "Principal": { "AWS": "123456789012" } 
  ```
* IAMロール指定
  ``` json
  "Principal": { "AWS": "arn:aws:iam::123456789012:role/role-name" }
  ```
* ロールセッション指定
  ``` json
  "Principal": { "AWS": "arn:aws:iam::123456789012:assumed-role/role-name/role-session-name" }
  ```
* IAMユーザー指定
  ``` json
  "Principal": { "AWS": "arn:aws:iam::123456789012:user/user-name" }
  ```
  > IAMユーザーグループに対する指定は不可
* AWSサービス指定
  ``` json
  "Principal": {
      "Service": [
          "ecs.amazonaws.com",
          "elasticloadbalancing.amazonaws.com"
     ]
  }
  ```

### IAMユーザーの種別
* ルートユーザー
  + IAMではない
  + AWSアカウント作成時に作られるIDアカウント
* 管理者権限のIAMユーザー
  + IAMの操作権限を持つ
* パワーユーザー権限のIAMユーザー
  + IAM以外のすべてのAWSサービスにフルアクセスできる
  + IAMの操作権限はなし

### IAMポリシー
* ポリシーの宣言
  * 管理ポリシー
      * AWS管理ポリシー
      * カスタマー管理ポリシー
  * インラインポリシー
* ポリシーのタイプ
  * ユーザーベース（アイデンティテイベース、IDベース）のポリシー
  * リソースベースのポリシー
* ポリシー効果
  * 許可ポリシー：Deny/Acceptを設定
  * 信頼ポリシー：ユーザーやリソースへの信頼を設定

#### Permissions boundary
* IAMユーザーに対して権限境界（Permissions boundary）を設定して、
  付与可能な権限範囲をあらかじめ制限できる

#### IAMポリシーの条件指定の例
* タグを条件としたIAMポリシー
  * https://aws.amazon.com/jp/premiumsupport/knowledge-center/iam-ec2-resource-tags/
  * IAMポリシーでEC2インスタンス等のリソースタグを条件に加えることで、例えば本番環境/開発環境ごとに運用ポリシーを変えることが可能に
* VPCを条件としたIAMポリシー
  * https://qiita.com/ijin/items/8c53735ee5671cadbf2c
  * IAMポリシーでEC2インスタンス等のリソースタグを条件に加えることで、例えば本番環境/開発環境ごとに運用ポリシーを変えることが可能に

### IAMのアクティビティ監視
* IAM Access Analyzer
  * 外部エンティティ（別のAWSアカウントなど）と共有されるS3やIAMロールなど
    組織とアカウントのリソースを識別して、セキュリティリスクとなるような
    リソースとデータへの不適切なアクセスがないかを特定する
* IAM Access Advisor
  * IAMアイデンティティ（ユーザー、グループ、ロール）に許可されている
    サービスとアクセス日時を表示
* Credential Report
  * 特定のIAMアイデンティティのIAM認証情報のレポートファイル
* AWS Config
  * IAMアイデンティティやIAMポリシーの変更履歴を記録するサービス
* AWS CloudTrail
  * IAMアイデンティテイのアクティビティやAPIコールをログに記録し、モニタリングするサービス

---
## STS（Security Token Service）
限定的かつ一時的にセキュリティ認証情報を提供するサービス

* AWSサービスへのアクセスの提供
  * サービスロールを設定してアクセス権限を付与
* 別のAWSアカウントへのアクセス許可
  * クロスアカウントアクセス設定
* 外部で認証されたユーザー（IDフェデレーション）へのアクセス許可
  * ウェブIDフェデレーション
    * Amazon CognitoやOpenID Connectにより認証されたユーザー
  * SAML2.0フェデレーション
    * エンタープライズ系で利用？ IdPの認証情報を信頼する

> 参考リンク
> https://qiita.com/fjisdahgaiuerua/items/c8183dc19e95d9e13d4b

## Directory Service
https://aws.amazon.com/jp/directoryservice/
![](https://d1.awsstatic.com/Products/product-name/diagrams/directory_service_howitworks.80bfccbf2f5d1d63558ec3c086aff247147258f1.png)

ディレクトリサービス：ユーザーに関わる各種情報を保管してユーザー認証を実現する仕組み

* Simple AD
  * AWS側にフルマネージ型のディレクトリを新規に作成
* AD Connector
  * Micrsoft Active Diectoryへのリクエストを処理するゲートウェイサービス
  * IAMと組み合わせることで、AWSリソースにアクセスできるユーザーをMicrosoft ADで認証できる
* Managed Microsoft AD
  * AWS側にMicrosoft Acitive Directoryとの互換性があるフルマネージド方のADを作成

## Cognito
シンプルでセキュアなユーザーのサインアップ・サインイン、
およびアクセスコントロールをアプリケーションに実装
* モバイルアプリのSAML認証
* API Gatewayのセッションの認証

---
# インフラ保護
## VPC
* サブネットの適切な分割
* アクセス制御
  * サブネット単位の制御：ネットワークACL
  * インスタンス単位の制御：セキュリティグループ

---
# 検出制御
トラフィックや動作を監視・モニタリングを継続的に実施してセキュリティを高める

## CloudTrail
**AWSユーザー**の行動ログを取得し、ガバナンス、コンプライアンス、
および運用とリスクの監査を行えるように支援

## CloudWatch
**AWSリソース**と**AWSで実行するアプリケーション**に対して、
様々なメトリクスやログを収集・追跡するモニタリングサービス

## GuardDuty
AWS上で悪意のある操作や不正な動作を継続的にモニタリングする脅威検出サービス

## Inpsector
自動的にアプリケーションを検証し、その露出・脆弱性・ベストプラクティスからの逸断状況を確認し、セキュリティ評価を実施するサービス

## WAF（Web Application Firewall）
https://aws.amazon.com/jp/waf/
![](https://d1.awsstatic.com/products/WAF/product-page-diagram_APIv2-AWS-WAF_How-it-Works-2x.1cafa052deabb5ca8500ce9565209f0f97725482.png)

可能性、セキュリティ侵害、リソースの過剰消費といった一般的なウェブの脆弱性から、ウェブアプリケーションまたはAPIを保護する、ウェブアプリケーションファイアウォール。

## Shield
* 分散サービス妨害（DDoS）に対するマネージド型の保護サービス
* Shieldにはスタンダード・アドバンスドの2つの階層があり、サポート範囲が異なる
  * CloudFrontを使用する際は、自動的にShield Standardが適用される

## X-Ray
* Amazon APIからのAPIリクエストを通してサービスを呼び出した時に、
  そのユーザリクエストを追式および分析できる
  + API Gateway
    - X-Rayトレースをサポートしており、トレースデータの収集が可能
