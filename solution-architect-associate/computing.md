# コンピューティング

---
## EC2
仮想サーバを提供するマネージド型のコンピューティングサービス

### EC2の特徴
* 数分で利用可能となる従量課金の仮想サーバ
* 汎用的なIntelアーキテクチャーを採用
* LinuxやWindowsのほどんどのOSをサポート
* OSまではタイプを選択することで自動設定、OSより上のレイヤーは自由に利用可能
* 独自のAMIにOS設定を作成し、保存・再利用が可能

### インスタンスファミリー

| ユースケース | ファミリー | 特徴 |
| --- | --- | --- |
| 汎用 | A1,M5,T3 | インスタンスのリソースを同じ割合で消費するアプリケーションに最適 | 
| コンピューティング最適化 | C5,C6g | バッチ処理ワークロード、メディアトランスコード、hpcなどで最適 |
| メモリ最適化 | X1,R5,z1d | メモリ内の大きなデータセットを処理するワークロードに最適 | 
| ストレージ最適化 | H1,D2,I3en | ローカルストレージの大規模データセットに対する高いシーケンシャル読み取り/書き出しに最適<br>・H1,D2はHDDベース<br>・I3,I3enはSSDベース（大量のIOPSに対応できる） |
| 高速化コンピューティング | P3,G4(GPU),F1(FPGA) | ハードウェアアクセアクセラレータを用いた計算処理に最適 |

### ユーザーデータの利用
* ユーザーデータ
  - EC2インスタンスの詳細設定の自動化に利用
  - Bashスクリプトなどを設定して、インスタンス起動時に実行されるように準備できる
* ブートストラップ
  - インスタンスにユーザーデータを渡すことで、起動時に実行される処理のこと

### インスタンス内のストレージ
* EBS
  - [EBS](./storage.md#ebs) を参照
* インスタンスストア
  - Instance store-backed AMIを利用してインスタンスを作成すると、このインスタンスのデータはインスタンスストア（=物理ホストのローカルディスク）に保存される
  - インスタンスストアはインスタンスの存続期間中のみ持続するため、インスタンスが終了すると自動的に削除される
  - EBSとは異なり料金は発生しない（EC2の料金に含まれる）

### インスタンスの購入方式
1. オンデマンドインスタンス
    * 通常のインスタンス購入方式
    * 長期契約（事前のコミット）なし。秒or分単位で課金
    * ユーザー側でライフサイクルを完全に制御できる
2. リザーブドインスタンス
    * 1年or3年の期間利用をコミットすることで、最大72%の割引が可能
      - スタンダード：インスタンスタイプが固定
      - コンパーティブル：スタンダードと比べて割引率は低いが、期間中のインスタンスタイプ変更は可能
    * 購入には1年or3年のコミットメントが必要。もし途中で不要になった場合は「リザーブドインスタンスマーケットプレイス」で販売することも可能
3. スポットインスタンス
    * AWSが予備で保持している未使用のインスタンスに対して入札して利用。最大90%割引
    * 実行時間に柔軟性をもつ場合、処理が途中で中断しても構わない場合に利用する

### キャパシティ予約
* キャパシティを事前に予約し購入
* EC2インスタンスの実行有無に関わらずオンデマンドの料金は発生。ただし、リージョンRI（リザーブドインスタンス）とのセット利用が可能なため、それで費用を削減できる。
* 特にDedicated Hostでテナンシーを占有する選択をした場合に、需要の状況次第で必要なキャパシティを確保できないようなケースで、このキャパシティ予約が有効に働く
* 料金はキャパシティを予約確保するだけで、最低でもRIと同様の費用がかかるが、RIの様に長期（1年or3年）の期間コミットが不要な分、柔軟性がある。
* 参考リンク
  * https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-capacity-reservations.html
  * https://dev.classmethod.jp/articles/ec2-capacity-reservations/

> 【重要】スケジュールドリザーブドインスタンスが利用不可となったため
> 代替手法としてこの方法を使う必要がある

| 形式 | 期間 | キャパシティメリット | 請求割引 | インスタンスの制限 |
| --- | --- | --- | --- | --- |
| キャパシティ予約 | 事前のコミットは不要。必要に応じて作成・キャンセル | 特定のAZのキャパシティを予約 | 割引なし。通常のオンデマンドのレートと同じ。リージョンRIとの併用で割引可能 | リージョンごとのオンデマンドインスタンスの制約に依存 |
| ゾーンRI | 1年or3年の事前コミットが必要 | 特定のAZのキャパシティを予約 | 割引あり | AZごとに20台 |
| リージョンRI | 1年or3年の事前コミットが必要 | 特定のリージョンのキャパシティを予約 | 割引あり | AZごとに20台 |

### RIとSaving Plans（SP）の比較
* 参考リンク
  - https://dev.classmethod.jp/articles/ec2-reserved-instances-savings-plans-comparison/
  - https://qiita.com/nasuvitz/items/1317495450e91c987cba
* 期間の事前コミットは差異なし
* SPはインスタンスファミリーやAZやリージョンの指定が不要なことがあり、柔軟な運用が可能。また、EC2だけでなくFargeteやLambdaにも適用される。一方、コミット額を自分で算出（予測）する必要がある
* 一方、RIはこれらの条件を事前にすべて決定する分、コミット額は自動的に割り出される

### 物理テナンシー
* ハードウェア専有インスタンス
  - 別アカウントのインスタンスが同じ物理サーバで起動しないことだけを保証
  - 同じアカウントのインスタンスとはHWを共有する可能性がある
    （同じルートアカウントのメンバーアカウントは「同じアカウント」扱いになる」
* Dedicated Host
  - 完全にそのアカウントの専用として利用できる物理サーバ
  - さらに、同じAWSアカウントに属するIAMユーザー/グループに対しても、
    権限付与によりそれらと物理サーバを共有しないことが可能
* Bare Metal
  - アプリケーションがサーバのプロセッサやメモリ、OSの直下層のHWに直接アクセス可能
  - 結果的に、インスタンスがその物理サーバを完全に専有している

つまり、アカウントのHWの専有の度合いは、`HW専有インスタンス < Dedicated Host < Bare Metal`

### EC2フリート
オンデマンドインスタンスとスポットインスタンスで構成されるインスタンスグループとして設定を定義する仕組み

* 例えば、フリートのキャパシティを15として、
  + 起動テンプレートで、インスタンスタイプを定義
    - さらにオンデマンドインスタンスのキャパシティ（例えば10）、スポットインスタンスのキャパシティ（例えば5）と定義
    - ....

### AMI
インスタンスを起動する際は元となるイメージを選んで作成する。
この元となるイメージをAMI（Amazon Machine Image）と呼ぶ。

* AMIを作成する際は、このイメージの管理情報とEBSスナップショットがセットで作成される（イメージの管理情報のスナップショットだけを作成することはできない）
* AMIのイメージ情報そのものは課金されない（EBSスナップショットの方は課金される）
* プロビジョニング・設定済みで起動すればすぐに稼働できる状態のAMIを「ゴールデンイメージ」と呼ぶらしい

### プレイスメントグループ
* インスタンス間の通信速度を高速化させる機能（ネットワークのレイテンシーを削減する機能）
* 単一AZ内の複数のEC2インスタンスをグループ化することで、物理的になるべく近いインスタンスとして起動
* 複数のAZを跨ぐグルーピングやネットワーク帯域が小さいインスタンスタイプはグループ化できない

### EC2 Config
* https://dev.classmethod.jp/articles/cm-advent-calendar-2015-aws-re-entering-ec2-windows/#windows-ec2config
* Windows on EC2で動作するWindowsのエージェント
* Linuxのcloud-initに相当するもので、Windowsの起動時に各種設定を行なってくれる

### EC2のログ
* 稼働状況のログ
  - CloudWatchエージェントをEC2インスタンスに導入しCloudWatch Logsに自動転送
* トラフィックのログ
  - フローログを有効にすることにより、ネットワークのトラフィックログをCloudWatchで取得できる

## BYOIP
* EC2インスタンスで自前のIPアドレスを利用する
* ROA（Route Origin Authorization）という認証を通す
  * https://fluid-27.hatenablog.com/entry/2021/07/16/204216

## vCPU制限
* インスタンスサイズ毎にvCPU数の制限がある
  * https://blog.serverworks.co.jp/tech/2019/11/05/ec2-new-limit/
  * 制限の緩和はサービスクォータで申請
* 2019/9/24より導入された機能。それまではインスタンス数での上限だった
  （1ファミリーあたり合わせて最大20個）

---
## Elastic Load Balancing
![](https://docs.aws.amazon.com/ja_jp/elasticloadbalancing/latest/userguide/images/cross_zone_load_balancing_enabled.png)

* ELBは複数の計算リソースの並列処理を可能にするロードバランサ―を提供するサービス
* ELBはマネージドサービスであり、ELB自体も負荷に応じて自動的にキャパシティを上限
  * ロードバランサーがボトルネックにならないのは重要であり、AWSがこれを管理してくれるのは大きな導入メリット
  * ただし、ELBのスケーリングは瞬時に完了するわけではないので、急激なスパイクが予想されるならプレフォーミング申請が必要

### ELBの特徴
* 高可用性
  * 複数のAZにある計算リソースの中から正常なターゲットのみに振り分け
  * ヘルスチェックによりトラフィックが正常なリソースを識別
* スケーラビリティの確保
  * トラフィックを複数の計算リソースへの自動的に分散
  * 前述の通りELB自身も負荷に応じてキャパシティを自動で上限

### ELBの主要機能

| 機能 | 特徴 |
| --- | --- |
| ヘルスチェック | 配下のリソースのトラフィックの正常/異常を確認。正常なターゲットにトラフィックを振り分け |
| クロスゾーン負荷分散 | 複数のAZに跨るリソースに対し自動的にトラフィックを分散 |
| 暗号化通信 | SSL/TLS証明書をELBに設定することでHTTPSまたはTLS通信が可能に。（証明書はACMから発行するのがかんたん） |
| スティッキーセッション | セッション中に同じユーザーから来たリクエストを継続して同じターゲットに送信 |
| Connection Draining | ロードバランサーが接続を維持する最大タイムアウト時間（1〜3600秒。デフォルト300秒）を指定できる。最大タイムアウト時間に達すると、ロードバランサーはインスタンスへの接続を強制的にクローズする |
| ログ取得 | ELBのログ取得を有効にすると、S3バケットにログを収集 |

### ELBのタイプ
現在利用できるロードバランサーは3種類

| タイプ | 特徴 |
| --- | --- |
| ALB | ・レイヤー7、HTTP/HTTPSリスナーに対応<br>・パスルーティングが可能<br>・時間に応じたLCUの使用量で課金[※]<br>・IPアドレスが可変。指定時にDNSのみ利用可能<br>・クロスゾーン負荷分散がデフォルトで有効 |
| NLB | ・レイヤー4、TCPリスナーに対応（戻りトラフィックはNLBを経由しない）<br>・サブネット拡張サポート（サブネットを追加できる）<br>・固定IPのためDNSとIPアドレスのどちらも利用可能<br>・時間に応じたLCUの使用量で課金<br>・ALBよりも高パフォーマンスで処理が可能<br>・クロスゾーン負荷分散がでデフォルトで無効 |
| CLB | ※古いタイプなので現在はALB/NLBの利用を優先<br>・レイヤー4と7に対応しており、TCP,SSL,HTTP,HTTPSリスナーを利用<br>・データ転送(GB単位)に応じて課金<br>・IPアドレスが可変であるため、指定時のDNSのみ利用可能 |

> [※]LCU=Load balancer Capacity Unit

### ALB
上記のテーブル以外の特徴を列挙

* WebSocketとHTTP/2のリクエストを受付
* 1ターゲットに複数ポートを登録可能
* ターゲットグループでのヘルスチェックが可能
  - ターゲットグループのターゲットはAZを跨ぐことができる
* 加重ロードバランシングが可能
* URLパス/リクエスト内容に基づいたルーティングが可能。（それぞれパスルーティング/コンテントルーティング）
  - パスルーティング： 例) `example.com/order` と `example.com/procure` でターゲットグループを振り分ける

### NLB
上記のテーブル以外の特徴を列挙

* 揮発性ワークロードにより、毎秒数百万リクエストに対応できる能力
* 複数ポートでの各リソースまたはIPアドレスを同ターゲットグループに登録可能
* ALBやCLBは `X-Forwarded-For` でアクセス元IPアドレスを判断するが、NLBは送信元IPアドレス・ポートを書き換えないため、パケットからアクセス元を判断可能
* NLBはフォールトトレランス機能を内蔵したコネクションを持ち、数カ月〜数年のオープンなコネクションを処理できる

---
## Auto Scaling
![](https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/images/sample-3-tier-architecture-with-azs-diagram.png)

システムの利用状況（設定した閾値やヘルスチェックの結果）によって、インスタンスの台数を自動的に増減させるサービス

* トリガーとするメトリクスとして、ヘルスチェックの結果やCPU使用率は扱えるが、メモリ使用率は扱えない
* 閾値を超えたにも関わらずスケーリングが上手く実行されずに24h以上経過した場合、自動的にAuto Scalingが停止するようになっている
  > 詳細は https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/as-suspend-resume-processes.html


### キャパシティ
![](https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/images/as-basic-diagram.png)

| 項目 | 内容 |
|--|--|
| 希望キャパシティ | 定常時に作成されるEC2インスタンスの数。この数値を変更することで手動でスケーリングさせることを可能 |
| 最小キャパシティ | Auto Scalingグループ作成後にすぐ作成されるEC2インスタンスの数 |
| 最大キャパシティ | 需要の増加に応じてスケールアウトする時のEC2インスタンス数の上限。タイミングや条件をスケーリングポリシーで設定 |

### 設計ポイント
* インスタンス（サーバ）をステートレスに設計
* AZをまたがってインスタンスを配置するように設計
  - 例) インスタンスが1台故障しても100%の稼働状態を実現するには？
  - 3つのAZにまたがってAuto Scaling
  - ピークロードを50%処理できるよう設定
  - => 1台故障してもピークロード50%x2台=（机上では）稼働率100%を維持

### スケーリングポリシー
https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/scaling_plan.html

| ポリシー | | 内容 |
| --- | --- | --- |
| 動的スケーリング | 簡易スケーリング | １つのメトリクスに対して１つの閾値を設定。現在は非推奨 |
| | ステップスケーリング | １つのメトリクスに対して１つ以上の閾値を設定し、段階ごとのスケーリング設定が可能。簡易スケーリングの上位互換 |
| | ターゲット追跡スケーリング | CloudWatchのモニタリングメトリクスに対して目標値を設定し、それを維持するように自動的に調整。今後の主流になると思われる |
| 手動スケーリング | | 希望する容量を手動で調整。いつでも実施可能 |
| 予測スケーリング | | 機械学習を使用して CloudWatch からの履歴データに基づいてキャパシティー要件を予測 |
| スケジュールスケーリング | | 予想可能なロードの変化に応じて独自のスケーリングスケジュールを設定 |

### ヘルスチェック
EC2ステータス、ELBからヘルスチェックを利用する。

- EC2ステータス
  + インスタンスのステータスがrunning以外であるとき、またはシステムのステータスがimpairedであるときに、インスタンスを異常とマークする
- ELB
  + Elastic Load BalancingがOutOfServiceと見なすと、インスタンスを異常とマークする

> 例えば、トラフィックの高負荷が発生した場合、EC2のステータスはhealthyだが
> ELB->EC2のトラフィックが通らず、ELBのステータスがOutOfServiceとなる場合がある。
> このような場合に、Auto Scalingのヘルスチェック先にELBを加わっていなければ、
> スケールアウトが発動しない、といったことが起き得る。

* 猶予期間
  * 一定期間はヘルスチェックをしないという猶予期間。プロセス起動中などを異常と誤検知しないためのもの。デフォルトは300秒（5分）だが変更可能

### 終了ポリシー
需要減にもとづくスケールインの際に、どのインスタンスから終了するかを設定。

* デフォルト
  * AZの選択
    * いちばん多いインスタンスが配置されているAZからインスタンスを削除
    * それで決定できない場合は、ランダムで削除
  * インスタンスの選択
    * 起動設定/テンプレートがいちばん古いインスタンスを削除
    * 古いインスタンスが複数ある場合は、次の課金発生が短いインスタンスを削除
    * それで決定できない場合は、ランダムで削除
* カスタム
  * AZの選択：同上
  * インスタンスの選択
    * 選択したAZのカスタムポリシー
      * OldestInstance：最も古いインスタンスから順番に終了
      * NewestInstance：最も新しい起動時刻のインスタンスから終了
      * OldestLaunchConfiguration：最も古い起動設定により起動しているインスタンスから終了
      * ClosetToNextInstanceHour：次の課金が始まるタイミングが最も近いインスタンスから終了

### ウォームアップ・クールダウン
* クールダウン
  - Auto Scalingが発動した直後では、追加でインスタンスの増減がなされるこ
  とを防ぐための設定
* ウォームアップ
  - 主にステップスケーリングにおいて、次のステップのためのインスタンスの一部を事前に起動しておくための設定


---
## ECS
- Dockerコンテナによるサービス環境を提供するフルマネージドサービス
- プロビジョンニングの操作や管理、ネットワークのトラフィック制御の設定や管理等を行える

### ECSの構成要素
* タスク
  - ECS上で実行されるコンテナのこと
  - タスク単位（コンテナ単位）でIAMロールを割り付けて権限を振ることが可能
    + https://dev.classmethod.jp/articles/20160715-ecs-task-iam-role/
* サービス
  - 1つまたは複数のタスク（コンテナ）で実現するサービスの単位
  - Webサービス=フロントエンドタスク＋APサーバタスク＋DBサーバタスク のような形。Docker Composeに近い
* クラスタ
  - タスク・サービスおよびタスクを実行するインスタンスを管理
  - 1つのクラスタで複数サービス・複数タスクを同時に実行できる

### 起動モード
EC2とFargateから選択可能

* EC2
  - コンテナインスタンスとしてEC2インスタンスを起動。
    そのため、サービスアプリを実行するインフラに対して詳細なコントロールが可能
  - タスクスケジュールにより、コンテナインスタンスのコンテナ配置をスケジュール可能（Fargateも同様）
* Fargate
  - コンテナインスタンスの管理が不要
  - CPU・メモリなどのアプリ要件を定義すると、必要なスケーリングやインフラはFargateで管理
  - 秒単位で数万個のコンテナを起動可能

---
## Lambda
サーバーレスでコードを実行できるコンピューティングサービス

### スペック
* 同時実行数：1000
* 関数とレイヤののストレージ：75GB
* 一時ボリューム（`/tmp`）の最大制限：512MB

### Lambda Layer
* Lambda関数間で共通するコンポーネントを
  Lambdaレイヤーとして定義し参照できる（最大5つまで）
