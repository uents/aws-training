# コンピューティング

## EC2

### EBS
[EBS](./storage.md#ebs) を参照

### インスタンスストア
* Instance store-backed AMIを利用してインスタンスを作成すると、このインスタンスのデータはインスタンスストア（=物理ホストのローカルディスク）に保存される
* インスタンスストアはインスタンスの存続期間中のみ持続するため、インスタンスが終了すると自動的に削除される

### ハードウェアの専有
* Dedicated Host
  - 物理的にサーバを占有するインスタンスタイプ
  - 同じAWSアカウントに属するIAMユーザー/グループに対しても、
    権限付与によりそれらと物理サーバを共有しないことが可能
* ハードウェア専有インスタンス
  - 他のAWSアカウントに属するインスタンスとは物理的に分離するが、
    同じAWSアカウントとはHWを共有すか可能性があるため、
    Decicated Hostの方がより強力に分離できる

### キャパシティ予約
キャパシティを事前に予約し購入する。
EC2インスタンスの実行有無に関わらずオンデマンドの料金は発生する。
ただし、リージョンRI（リザーブドインスタンス）とのセット利用が可能なため、
それで費用を削減できる。

特にDedicated Hostでテナンシーを占有する選択をした場合に、
需要の状況次第で必要なキャパシティを確保できないようなケースで、
このキャパシティ予約が有効に働く。

料金はキャパシティを予約確保するだけで、最低でもRIと同様の費用がかかるが、
RIの様に長期（1年or3年）の期間コミットが不要な分、柔軟性がある。

* https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-capacity-reservations.html
* https://dev.classmethod.jp/articles/ec2-capacity-reservations/

> 【重要】スケジュールドリザーブドインスタンスが利用不可となったため
> 代替手法としてこの方法を使う必要がある

| 形式 | 期間 | キャパシティメリット | 請求割引 | インスタンスの制限 |
| --- | --- | --- | --- | --- |
| キャパシティ予約 | 事前のコミットは不要。必要に応じて作成・キャンセル | 特定のAZのキャパシティを予約 | 割引なし。通常のオンデマンドのレートと同じ。リージョンRIとの併用で割引可能 | リージョンごとのオンデマンドインスタンスの制約に依存 |
| ゾーンRI | 1年or3年の事前コミットが必要 | 特定のAZのキャパシティを予約 | 割引あり | AZごとに20台 |
| リージョンRI | 1年or3年の事前コミットが必要 | 特定のリージョンのキャパシティを予約 | 割引あり | AZごとに20台 |

### RIとSaving Plans（SP）の比較
* 参考リンク
  - https://dev.classmethod.jp/articles/ec2-reserved-instances-savings-plans-comparison/
  - https://qiita.com/nasuvitz/items/1317495450e91c987cba
* 期間の事前コミットは差異なし
* SPはインスタンスファミリーやAZやリージョンの指定が不要なことがあり、柔軟な運用が可能。また、EC2だけでなくFargeteやLambdaにも適用される。一方、コミット額を自分で算出（予測）する必要がある
* 一方、RIはこれらの条件を事前にすべて決定する分、コミット額は自動的に割り出される


---
## Auto Scaling
* システムの利用状況（設定した閾値やヘルスチェックの結果）によって、インスタンスの台数を自動的に増減させるサービス
* ただし、閾値を超えたにも関わらずスケーリングが上手く実行されずに24h以上経過した場合、自動的にAuto Scalingが停止するようになっている
  > 詳細は https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/as-suspend-resume-processes.html


### 設計ポイント
* インスタンス（サーバ）をステートレスに設計
* AZをまたがってインスタンスを配置するように設計
  - 例) インスタンスが1台故障しても100%の稼働状態を実現するには？
    + 3つのAZにまたがってAuto Scaling
    + ピークロードを50%処理できるよう設定
    + => 1台故障してもピークロード50%x2台=（机上では）稼働率100%を維持

### スケーリングポリシー
https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/scaling_plan.html

| ポリシー | | 内容 |
| --- | --- | --- |
| 動的スケーリング | 簡易スケーリング | １つのメトリクスに対して１つの閾値を設定。現在は非推奨 |
| | ステップスケーリング | １つのメトリクスに対して１つ以のの閾値を設定し、段階ごとのスケーリング設定が可能。簡易スケーリングの上位互換 |
| | ターゲット追跡スケーリング | １つのメトリクスに対して目標値を設定し、Auto Scalingグループがその目標値を維持するように自動的に調整。今後の主流になると思われる |
| 手動スケーリング | | 希望する容量を手動で調整。いつでも実施可能 |
| 予測スケーリング | | 機械学習を使用して CloudWatch からの履歴データに基づいてキャパシティー要件を予測 |
| スケジュールスケーリング | | 予想可能なロードの変化に応じて独自のスケーリングスケジュールを設定 |

### ヘルスチェック
* ヘルスチェックタイプ
  * EC2とELBの2種がある
    - EC2
      + インスタンスのステータスが running 以外であるとき、またはシステムのステータスが impaired である場合に異常とみなす
    - ELB
      + Elastic Load Balancing がOutOfServiceであるとき異常とみなす
  * 例えば、クライアント側からの高負荷が発生した場合、ELBが異常となることもあるので、ELBのヘルスチェックを利用したスケーリング設定も必要となることがある
* 猶予期間
  * 一定期間はヘルスチェックをしないという猶予期間。
    プロセス起動中などを異常と誤検知しないためのもの
  * デフォルトは300秒（5分）


---
## ECS
### 起動モード
EC2とFargateから選択可能

* EC2
  - コンテナインスタンスとしてEC2インスタンスを起動。
    そのため、サービスアプリを実行するインフラに対して詳細なコントロールが可能
  - タスクスケジュールにより、コンテナインスタンスのコンテナ配置をスケジュール可能（Fargateも同様）
* Fargate
  - コンテナインスタンスの管理が不要
  - CPU・メモリなどのアプリ要件を定義すると、必要なスケーリングやインフラはFargateで管理
  - 秒単位で数万個のコンテナを起動可能

