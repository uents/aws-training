# データベース
## AWSのデータベースとユースケース
https://qiita.com/leomaro7/items/e48d9941dab5b5f2a718

![](https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F280929%2F55f5c666-9788-3337-d09e-44dd955d4a9c.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&w=1400&fit=max&s=adc449aef758ec67efd22706d327a87c)

---
## RDS
* AWSが提供するマネージドサービス
* MySQL、MariaDB、PostgreSQL、Oracle、Microsoft SQL Severなどのデータベースエンジンから選択可能
  - MySQLのストレージエンジンはInnoDB（RDSではMyISAMは選択できない）
* 最大5台のリードレプリカを設置可能（Auroraは最大15台）

### マルチAZ
* 別AZにセカンダリーDBを作成することで、BCP対策が可能に
* 別リージョンにセカンダリーDBを作成することはできない（リードレプリカなら別リージョンへも可能）

### レプリケーションラグ
* Amazon RDS for MySQLのレプリケーションで遅延が発生しているかどうかを確認する方法 | DevelopersIO (classmethod.jp)
  - https://dev.classmethod.jp/articles/how-to-know-how-late-a-replica-in-rds-for-mysql-ver-5-series/
* RDS for Oracle インスタンスのリードレプリカによるレプリケーションラグのトラブルシューティング (amazon.com)
  - https://aws.amazon.com/jp/premiumsupport/knowledge-center/rds-oracle-troubleshoot-replication-lags/

### RDS Proxy
* https://aws.amazon.com/jp/rds/proxy/
* アプリケーションとRDSデータベースの仲介役として機能
* 必要となるデータベースへのコネクションプールを確立・管理するので、
  例えば、LambdaアプリケーションからのDB接続を自動的に少なく抑える
  + LambdaアプリケーションをRDSエンドポイントに直接接続するとコネクション多数で
    うまくいかないところを、RDS Proxyは効率的に実行できる

### IAM DB認証
* データベースに対する認証を、IAMユーザーまたはIAMロール認証で行うことができる
* https://blog.serverworks.co.jp/rds-iamdblogin

### RDS Auto Scaling
* 増加するデータベースのワークロードに対し、ストレージ容量がダウンタイムなしに自動的にスケールされる
* ただし、**ストレージ容量のスケーリング**であり、コンピューティングに対するものではない
  * I/Oのパフォーマンス向上には使用できないので注意

---
## Aurora
* MySQLやPostgreSQL等と互換性がある分散型RDB
  + エンジンのオプション
    - Aurora、MySQL、MariaDB、PostgreSQL、Oracle、Microsoft SQL Server
* マルチAZで分散されたクラスタ構成により、高速・高性能なRDBを実現
  + **最大で3つのAZに2つずつ、計6台のDBノード（レプリケーション）を設置可能**
  + **リードレプリカは最大15まで設置可能**
* クエリ処理量が多くOLTPで利用する業務用データベースに最適

![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/001-3.png)


### エンドポイント
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/04-1.png)

* クラスタエンドポイント
  * プライマリDBインスタンスに接続できる唯一のエンドポイント
  * 書き込み用途であればこれを選択
* 読み取りエンドポイント
  * リードレプリカに接続するエンドポイント
  * 読み込み用途であればこれを選択
  * リードレプリカが存在しない場合は、プライマリDBに接続する
    （この場合は確か書き込みが行えたはず）
* カスタムエンドポイント
  * 任意のDBインスタンスをグループ化して接続対象に設定できる

### Auroraリードレプリカ
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/13-2.png)

* Auroraレプリカと呼ばれることもある
* Auroraクラスタの読み取りオペレーションのスケーリングと可用性向上に利用されるリードレプリカ
* 最大15個まで設置可能
* プライマリDBと同じボリュームを参照するため、レプリカ遅延が遅い（通常は10ms）
  * https://dev.classmethod.jp/articles/re-introduction-2020-amazon-aurora/#toc-5

### Aurora Auto Scaling
* リードレプリカに対し、EC2のようなAuto Scaling機能を利用できる
* ターゲットメトリクス
  * Auroraレプリカの平均CPU使用率
  * Auroraレプリカの平均接続数
* クールダウン設定も可能（デフォルトは300秒）

### フェイルオーバー
* プライマリDBインスタンスに障害が発生した場合、**自動的にリードレプリカがプライマリDBインスタンスに昇格**
* リードレプリカに対しフェイルオーバーの優先度を設定することが可能
  （同値の場合、任意のリードレプリカが昇格）

### マルチマスタークラスタ
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/03-1.png)

* プライマリDBの2面持ちが可能になる
* 片方のプライマリDBに障害が発生した場合でも、もう片方のプライマリDBには継続的な書き込みができる

### Auroraサーバレス
![](https://cdn-ssl-devio-img.classmethod.jp/wp-content/uploads/2020/08/07-1.png)

* Auroraのオンデマンド自動スケーリング構成。クラスタありきの構成とは異なる
  + 自動的に起動/シャットダウン
  + 自動でスケールアップ/スケールダウン
  + 最小キャパシティ/最大キャパシティを事前に設定
* クラスタ構成ありきとは異なり、アプリケーションからの利用がない限り、コンピューティング性能に対しての費用がかからない
* 不定期で使用するアプリケーションや、可変ワークロードのアプリケーションで有用
* クラスタ構成のAuroraで使用できる機能の一部が使えない

### Auroraグローバルデータベース
* https://aws.amazon.com/jp/rds/aurora/global-database/
* 他のリージョンに高性能なリードレプリカを構築可能
* 概ね1秒以下・最大でも5秒という低レイテンシーでストレージレベルのレプリケーションを実現
* リージョン間のフェイルオーバーをサポート
  * マスターに障害が発生した場合、リーダーがマスターに昇格することでフェイルオーバーを実現
  * https://dev.classmethod.jp/articles/amazon-aurora-global-database-failover-between-region/

---
## Redshift
* マネージド型のDWH（データウェアハウジング）サービス
* 多くのソースからデータを収集し、データ全体の関係性や傾向を理解するのに役立つ機能を提供
* BI（ビジネスインテリジェンス）アプリケーションのの用途で活用

### アーキテクチャ
![](https://gihyo.jp/assets/images/dev/serial/01/redshift/0005/thumb/TH400_001.jpg)

* https://gihyo.jp/dev/serial/01/redshift/0005
* リーダーノード、複数のコンピュートノードからクラスタを構成
* 複数のコンピュートノードをまたがずに処理が完結できる分散構成をいかに作れるかがポイント

### ノードの役割
* リーダーノード
  - クライアントから実行クエリを受け付けて、クエリの解析・実行プランの作成を行い、コンピュートノードに分散して処理を実行させる
  - コンピュートノードの処理結果を受けて、クライアントにレスポンスを返す
* コンピュートノード
  - 計算処理を行うインスタンスおよびストレージから構成
     + インスタンスタイプを設定可能
     + オンデマンドインスタンスとリザーブドインスタンスが設定可能
     + リザーブドインスタンスの場合、1年or3年間の契約。最大75%のコスト削減
     + 自動および手動スナップショットを作成可能。自動スナップショットの空き容量上限に達すると課金が発生。手動スナップショットはストレージ料金が発生。ただし、保持期間の設定変更は可能
  - コンピュートノードを強化することでRedshiftクラスタの性能向上
* ノードスライス
  - コンピュートノード内での分散並列処理の最小単位
  - ノード内のスライス数はコンピューのノードのインスタンスタイプによって異なる

### ノードの購入方式
コンピュートノードを購入する際の方式を選択できる

* オンデマンドノード
  + 通常の料金が発生するノード
* リザーブドノード
  + EC2のリザーブドインスタンスと同じく、1年または3年の事前コミットを行う代わりに、
    割引料金が適用される

### クロスリージョンスナップショット
* クラスタのプライマリリージョンでスナップショットが作成されると、セカンダリリージョンにコピーされる
* プライマリリージョンのクラスタがダウンした場合、セカンダリリージョンでクラスタを即座に復元できる

### 拡張VPCルーティング
* https://docs.aws.amazon.com/ja_jp/redshift/latest/mgmt/enhanced-vpc-routing.html
* https://dev.classmethod.jp/articles/20161020-redshift-enhanced-vpc/
* VPCに出入りするRedshiftクラスタのトラフィックを監視することができる
  * Redshiftはクラスタとデータリポジトリ間のすべてのCOPY,UPLOADトラフィックがVPCを通るように強制し、VPCフローログを使って監視する
* さらに、VPC機能やVPCエンドポイント、IGWなどの標準的なVPCの機能も使用することができる

> VPCエンドポイントを使うと、VPC外のサービスの接続や連携ができるようになる

### Work Load Management
* Redshiftのクエリ処理の実行順序を（キューで）定義することができる機能

---
## DynamoDB
サーバレスのKey-Valueストア形式のマネージド型データベース
* プロビジョニング、パッチ適用、管理等が不要
* 高スケーラブル（自動的にスケーリング）、高負荷でも低レイテンシー
* 高可用性：データは3箇所のAZに自動的に保存
* プロビジョンドスループット
  * Read/Writeごとに必要すスループットのキャパシティを割り当てる
* ストレージ容量に制限がない
* リザーブドキャパティによる事前購入割引がある
  * https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/HowItWorks.ReadWriteCapacityMode.html

### ユースケース
1. ビッグデータ
    * 大量のデータを収集・蓄積・分析するためのデータベース
    * Hadoopと連携してビックデータ処理か可能
2. アプリケーション
    * 数万人オーダーが同あアクセスして処理が必要になるアプリケーションのセッションデータ処理など
3. ユーザー行動データ管理
    * ユーザー情報やゲーム・広告などのユーザー行動データ向けDB
    * ユーザーIDごとに複数の行動履歴管理
4. バックエンドデータ処理
    * モバイルアプリのバックエンド/バッチ処理のロック管理/フラッシュマーケティング/ストレージのインデックス

> SAAの出題では2,3,4の用途で問われることが多い

### DynamoDBの整合性モデル
* Write
  * 少なくとも2つのAZでの書き込み完了の確認が取れた時点で完了
* Read
  * デフォルト：結果整合性モデル
    * 書き込み直後の即時読み取りで反映前の状態が見えることがある
  * オプション：強い整合性モデル
    * GetItem/Query/Scanでは強い整合性のある読み込みオプションが指定可能

### DynamoDB Streams
* ユースケース
  1. クロスリージョンレプリケーション
      * ストリームのよるキャプションをトリガーとしてクロスリージョンレプリケーションを実施することが可能
  2. データ更新をトリガーとしたアプリケーション
      * 具体的にはLambda関数で実装
          * DynamoDBの別テーブルを更新
          * S3にログの保存
          * SNSを用いたプッシュ通知
      * Lambda関数のメモリ制約上、**512MBより大きなデータ/ファイルは扱えない**

### DynamoDB Auto Scaling
* Auto Scalingにより、負荷に応じてWCU/RCUのスループットを自動調整
* CloudWatchのモニタリングにもとづいて、トラフィックパターンに応じてプロビジョンドスループット性能をユーザーに代わって動的に調整

### DynamoDB Accelerator（DAX）
* インメモリキャッシュを利用しクエリを高速化（ms→usオーダー）
* インメモリキャッシュが高コストのため、「コスト最適」を求められた場合はDynamoDB Auto Scalingを選択する

### DynamoDBとRDSの違い

| 項目	| DynamoDB | RDS |
| --- | --- | --- |
| タイプ | 非リレショーナル | リレーショナル |
| データ構造 | Key-Value Store | SQL |
| サービス形態 | サーバレス | マネージド |
| スケーリング | 水平スケーリング | 垂直スケーリング[※1] |
| トランザクション | 結果整合性を保証 | ACID準拠 |
| アクセス性能 | 大量のアクセスでも性能維持 | 大量のアクセスには不向き[※2] |

* [※1] リードレプリカの増設によりある程度は対応可能
* [※2] RDS Proxyにコネクションプールを管理させることによりある程度は対応可能

---
## ElastiCache
* インメモリ・データストアサービス
* RedisとMemcachedのマネージドサービスとして使用可能
* 具体的な用途
  + アプリケーションのセッション情報
  + DBのクエリ結果のキャッシュ

### RedisとMemcachedの特徴

| 特徴 | Redis | Memcached |
| --- | --- | --- |
| データ型 | 複雑なデータ型を設定可能 | シンプルなデータ型に限る |
| 複数のデータベースのサポート | あり | なし |
| キーストアの永続性 | あり | なし |
| バックアップ・復元 | あり | なし |
| スケーラビリティ | リードレプリカを設置可能 | システムの需要の増減に応じてノードを増減 |
| 可用性 | レプリケート＆自動フェールオーバが可能 | ? |
| pub/sub機能 | あり | ? |
